name: Publish Plugin to Windy

on:
  workflow_dispatch:  # Permite execu√ß√£o manual

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Verify dist folder exists
        run: |
          echo "=== Verificando estrutura ==="
          ls -la
          echo ""
          echo "=== Conte√∫do da pasta dist ==="
          ls -la dist/

      - name: Publish to Windy
        run: |
          echo "Preparando publica√ß√£o..."
          
          # Vamos trabalhar na pasta dist
          cd dist
          
          echo "=== Arquivos em dist ==="
          ls -la
          
          # Verifica se plugin.json existe
          if [ ! -f plugin.json ]; then
            echo "‚ùå ERRO: plugin.json n√£o encontrado em dist/"
            exit 1
          fi
          
          echo "=== Conte√∫do do plugin.json original ==="
          cat plugin.json
          
          # Cria arquivo plugin-info.json com informa√ß√µes do GitHub
          echo '{
            "repositoryName": "${{ github.repository }}",
            "commitSha": "${{ github.sha }}",
            "repositoryOwner": "${{ github.repository_owner }}"
          }' > plugin-info.json
          
          echo "=== Conte√∫do do plugin-info.json ==="
          cat plugin-info.json
          
          # Combina os dois JSONs
          echo "Combinando JSONs..."
          if command -v jq &> /dev/null; then
            echo "Usando jq..."
            jq -s '.[0] * .[1]' plugin.json plugin-info.json > plugin-combined.json
            mv plugin-combined.json plugin.json
          else
            echo "Usando Node.js..."
            node -e "
            const fs = require('fs');
            const plugin = JSON.parse(fs.readFileSync('plugin.json'));
            const info = JSON.parse(fs.readFileSync('plugin-info.json'));
            const combined = {...plugin, ...info};
            fs.writeFileSync('plugin.json', JSON.stringify(combined, null, 2));
            console.log('JSONs combinados com sucesso');
            "
          fi
          
          echo "=== plugin.json final ==="
          cat plugin.json
          
          # Cria arquivo tar com TODOS os arquivos da pasta dist
          echo "Criando arquivo tar..."
          tar cf plugin.tar --exclude='./plugin.tar' .
          
          echo "Enviando para Windy..."
          
          # Faz o upload
          response=$(curl -s -w "\n%{http_code}" -XPOST 'https://node.windy.com/plugins/v1.0/upload' \
            -H "x-windy-api-key: ${{ secrets.WINDY_API_KEY }}" \
            -F "plugin_archive=@./plugin.tar")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          echo "=== Resposta do servidor ==="
          echo "HTTP Code: $http_code"
          echo "Response: $body"
          
          # Verifica sucesso
          if [ "$http_code" = "200" ]; then
            # Extrai URL da resposta
            url=$(echo "$body" | grep -o 'https://windy-plugins.com/[^"]*')
            if [ -n "$url" ]; then
              echo ""
              echo "‚úÖ ‚úÖ ‚úÖ PLUGIN PUBLICADO COM SUCESSO! ‚úÖ ‚úÖ ‚úÖ"
              echo ""
              echo "üîó URL DO PLUGIN:"
              echo "$url"
              echo ""
              echo "üìù COMO USAR:"
              echo "1. Acesse https://www.windy.com"
              echo "2. V√° em Plugins ‚Üí Adicionar Plugin"
              echo "3. Cole esta URL: $url"
              echo "4. O plugin ser√° carregado!"
              echo ""
              # Define output para usar no GitHub
              echo "plugin_url=$url" >> $GITHUB_OUTPUT
            else
              echo "‚ö†Ô∏è  Publica√ß√£o OK mas n√£o encontrei URL na resposta"
              echo "Resposta completa: $body"
            fi
          else
            echo "‚ùå ‚ùå ‚ùå ERRO NA PUBLICA√á√ÉO ‚ùå ‚ùå ‚ùå"
            echo "C√≥digo HTTP: $http_code"
            echo "Resposta: $body"
            echo ""
            echo "Poss√≠veis problemas:"
            echo "1. Chave API inv√°lida ou expirada"
            echo "2. plugin.json mal formatado"
            echo "3. Servidor Windy indispon√≠vel"
            exit 1
          fi
          
          # Limpa
          rm plugin.tar plugin-info.json
